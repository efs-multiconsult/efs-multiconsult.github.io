<html>
  <head>
    <meta charset="utf-8" />
    <title>
      Flytanimasjon NRH
    </title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.23/esri/themes/light/main.css"
    />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="https://js.arcgis.com/4.23/"></script>

    <style>
      html,
      body,
      #viewDiv {
		height: 100%;
		width: 100%;
      }

	  #flytvelger {
		bottom: 50;
		padding-left: 50;
		z-index: 9;
	  }
	  .container {
		  position: relative;
		  height: 100%;
		  width: 100%;

	  }

      #menu {
        padding: 1em;
      }

      #menu > div {
        padding: 0.4em;
      }

      #sliceContainer {
        top: 50px;
		right: 50px;
		position: absolute;
      }

      #sliceOptions {
        margin: 0 15px;
      }

      #sliceOptions>button {
        margin-bottom: 15px;
      }

	  #route1 {
		  display: none;
		  color: black;
		  font-size: medium;
	  }

	  #stopwatch {
		position: absolute;
		bottom: 100;
		/* padding-left: 50; */
		left: 30;
		z-index: 9;
		margin: 5;
		background: white;
		opacity: 0.8;
		border: 1px solid;
		border-radius: 5px;
	  }



      select {
        font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
    </style>

    <script>
      require([
	  	"esri/identity/OAuthInfo", 
		"esri/identity/IdentityManager",
		"esri/portal/Portal", 
		"esri/config",
		"esri/portal/PortalQueryParams",
        "esri/WebScene",
        "esri/views/SceneView",
		"esri/views/layers/FeatureLayerView",
        "esri/layers/FeatureLayer",
        "esri/renderers/UniqueValueRenderer",
		"esri/renderers/SimpleRenderer",
		"esri/symbols/ObjectSymbol3DLayer",
		"esri/symbols/PointSymbol3D",
		"esri/symbols/WebStyleSymbol",
		"esri/renderers/visualVariables/RotationVariable",
		"esri/renderers/visualVariables/SizeVariable",
		"esri/widgets/Bookmarks",
		"esri/widgets/Expand",
		"esri/widgets/Slice",
        "esri/analysis/SlicePlane"
      ], (OAuthInfo, esriId, Portal, esriConfig, PortalQueryParams, WebScene, SceneView, FeatureLayerView, FeatureLayer, UniqueValueRenderer, SimpleRenderer, ObjectSymbol3DLayer, PointSymbol3D, WebStyleSymbol, RotationVariable, SizeVariable, Bookmarks, Expand, Slice, SlicePlane) => {

		
		var info = new OAuthInfo({
          // Swap this ID out with registered application ID
          appId: "uexIzIm27zMWY9XL",
          // Uncomment the next line and update if using your own portal
          portalUrl: "https://cloudgis.multiconsult.no/portal/",
          // Uncomment the next line to prevent the user's signed in state from being shared with other apps on the same domain with the same authNamespace value.
          // authNamespace: "portal_oauth_inline",
          popup: false
        });

        esriId.registerOAuthInfos([info]);

		
		esriId
			.checkSignInStatus(info.portalUrl + "/sharing")
			.then(function() {
			// ikke behov
		});

        esriId.getCredential(info.portalUrl + "/sharing");


        esriConfig.portalUrl = "https://cloudgis.multiconsult.no/portal/"
        

		
        const webscene = new WebScene({
          portalItem: {
            // autocasts as new PortalItem()
            id: "3e77843040374d9286998c5444b91780"
          }
        });

        const view = new SceneView({
          container: "viewDiv",
          map: webscene,
          qualityProfile: "high",
          environment: {
            lighting: {
              directShadowsEnabled: true,
              ambientOcclusionEnabled: true
            },
            atmosphere: {
              quality: "high"
            }
          }
        });

		
		let props = {
			segmentNum: 0
		};
		
		const plane1 = new SlicePlane({
          position: {
            y: 6653445.8178,
            x: 260716.2639,
            z: 144.5,
			spatialReference: 25833
          },
          tilt: 0,
          width: 400,
          height: 200,
          heading: 268
        });

		const plane2 = new SlicePlane({
          position: {
            y: 6653462,
            x: 260724,
            z: 117.8,
			spatialReference: 25833
          },
          tilt: 0,
          width: 200,
          height: 200,
          heading: 291
        });

		
        const renderer = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: {
            type: "web-style", // autocasts as new WebStyleSymbol()
			//styleUrl: "https://multiconsult.maps.arcgis.com/sharing/rest/content/items/a953c270686f49f981d30ddb85270f55/data",
			styleUrl: "https://multiconsult.maps.arcgis.com/sharing/rest/content/items/db09054d1bf54b46be22ef6901a798af/data",
			name: "legemegseng"
            //name: "Point symbol"
          },
          label: "label"
        };

		var sv = new SizeVariable();
		sv.field = "heightval";
		sv.axis= "height";
		sv.minDataValue= 1;
		sv.maxDataValue= 3;
		sv.minSize= 1;
		sv.maxSize= 3;

		var rv = new RotationVariable();
		rv.field = "rotation";
		rv.rotationType = "geographic";
		rv.axis = "heading";
		rv.valueExpression = "$feature.rotation"

		renderer.visualVariables = [ rv, sv ];

		console.log(sv);
		console.log(renderer);
        /* Create layer with routes */
        const punktlag = new FeatureLayer({
			url: "https://cloudgis.multiconsult.no/server/rest/services/Hosted/NyeRiks_Flyt_4_9_v2/FeatureServer",
			copyright: "Erlend",
			elevationInfo: {
				mode: "absolute-height",
				offset: 0
			},
			title: "punktlag",
			definitionExpression: "",
			renderer: renderer
        });
        webscene.add(punktlag);

		sliceWidget = new Slice({
			view: view,
			container: "sliceContainer"
		});

		sliceWidget.viewModel.shape = plane1;
		
		view.whenLayerView(punktlag).then(function (layerView) {
            featureLayerView = layerView;
			console.log(featureLayerView);
			featureLayerView.filter = {
				where: "1=0"
			};


		});

		var h1 = document.getElementsByTagName('h1')[0];
		var mseconds = 0;
		var seconds = 0;
		var minutes = 0;
		var i = 1;   
		function myLoop() {         //  create a loop function
			setTimeout(function() {   //  call a 150ms setTimeout when the loop is called	
				
				mseconds+= 200;
				
				if (mseconds >= 1000) {
					mseconds = 0;
					seconds++;
				}
				if (seconds >= 60) {
					seconds = 0;
					minutes++;
				} 
				
				h1.textContent = (minutes ? (minutes > 9 ? minutes : "0" + minutes) : "00") + ":" + (seconds > 9 ? seconds : "0" + seconds) + ":" + mseconds;


				// time + = 0.2	
				sliceWidget.viewModel.shape = plane1;
				featureLayerView.filter = {
					where: "nummer = "+i.toString()
				};
				//props.extent = featureLayerView.fullExtent
				//console.log(i)
				i++;                    //  increment the counter
				if (i < props.segmentNum) {           //  if the counter < 10, call the loop function
					myLoop(); 
					if (i >= 700) {
						sliceWidget.viewModel.shape = plane2;
						
					}                  //  ..  again which will trigger another 
				} else {
					i = 1
					console.log("animasjon over")
					featureLayerView.filter = {
						where: "nummer=0"
					};
				}
                 //  ..  setTimeout()
			}, 150)
		}

		// Sjekker hvor mange segmenter det er i linja og lagrer i et obj
		punktlag.queryFeatureCount().then(function(numFeatures){
			props.segmentNum = numFeatures;
			console.log(props.segmentNum);
		});
        
		/*
		punktlag.queryExtent().then(function(results){
		// go to the extent of the results satisfying the query
			//props.extent = results.extent;
		});
		*/

		const r1 = document.getElementById("route1");
		
        r1.addEventListener("click", (event) => {
			console.log("KATTE");
			//view.goTo(props.extent);
			//sliceWidget.viewModel.shape = plane2;
			minutes = 0;
			seconds = 0;
			mseconds = 0;
			myLoop();
        });

		view.when(function() {
			r1.style.display = "block";// All layer and basemap resources have been loaded and are ready to be displayed
		});


      });
    </script>
  </head>

  <body>
	<div class="container">
			<div id="viewDiv" class="col esri-widget"></div>

			<div id="flytvelger" class="btn-toolbar mb-3 position-absolute" role="toolbar" aria-label="Toolbar with button groups">
				<div class="btn-group me-2" role="group" aria-label="First group">
					<button value="1" id="route1" type="button" class="btn btn-outline-secondary bg-white">Start flytt</button>
				</div>
			</div>

			<div id="bookmarkDiv"></div>

			<div id="sliceContainer"></div>

			<div id="stopwatch"> 
				<h1><time>00:00:00</time></h1> 
				<h2> mm:ss:ms </h2>
			</div>

	</div>

  </body>
</html>